<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="IBudget.GUI.Views.DictionariesPageView"
             xmlns:vm="using:IBudget.GUI.ViewModels"
             x:DataType="vm:DictionariesPageViewModel"
             x:CompileBindings="True">

	<Grid>
		<!-- Main Content -->
		<ScrollViewer VerticalScrollBarVisibility="Auto">
			<StackPanel Margin="30">
				<!-- Header Section -->
				<StackPanel Spacing="10" Margin="0,0,0,30">
					<TextBlock Text="Tag Dictionary Management"
                              FontSize="24"
                              FontWeight="Bold"
                              HorizontalAlignment="Center"
                              Foreground="{DynamicResource TextControlForeground}" />
					<TextBlock Text="View and manage expense categorization rules and mappings"
                              FontSize="14"
                              HorizontalAlignment="Center"
                              Opacity="0.7"
                              Foreground="{DynamicResource TextControlForeground}" />
				</StackPanel>

				<!-- Search Bar Section -->
				<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20"
                        Margin="0,0,0,20">
					<StackPanel Spacing="10">
						<TextBlock Text="ðŸ” Search Dictionary"
                                  FontSize="14"
                                  FontWeight="SemiBold"
                                  HorizontalAlignment="Center"
                                  Foreground="{DynamicResource TextControlForeground}" />
						
						<Grid ColumnDefinitions="*, Auto">
							<!-- Search TextBox -->
							<TextBox Grid.Column="0"
									 Text="{Binding SearchText}"
									 Watermark="Search by description, rule, or tag..."
									 FontSize="13"
									 Padding="12,8"
									 CornerRadius="6"
									 Background="{DynamicResource ControlFillColorDefaultBrush}"
									 BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
									 Margin="0,0,10,0" />
							
							<!-- Reset Button -->
							<Button Grid.Column="1"
									Content="ðŸ”„ Reset"
									Command="{Binding ResetSearchCommand}"
									IsVisible="{Binding IsSearchActive}"
									Padding="15,8"
									FontSize="13"
									CornerRadius="6"
									Background="{DynamicResource ControlFillColorDefaultBrush}"
									BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
									BorderThickness="1"
									ToolTip.Tip="Clear search and show all items" />
						</Grid>
						
						<!-- Search Status -->
						<TextBlock Text="{Binding ExpenseTagsInfo.Count, StringFormat='Found {0} expense tag(s)'}"
								   IsVisible="{Binding IsSearchActive}"
								   FontSize="12"
								   HorizontalAlignment="Center"
								   Opacity="0.7"
								   Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}" />
					</StackPanel>
				</Border>

				<!-- Content Grid -->
				<Grid ColumnDefinitions="1*, 1*">

					<!-- Expense Dictionaries Section -->
					<StackPanel Grid.Column="0" Margin="0,0,15,0">
						<!-- Section Header -->
						<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8,8,0,0"
                                Padding="20,15">
							<StackPanel Spacing="5">
								<TextBlock Text="ðŸ“ Expense Dictionaries"
                                          FontSize="18"
                                          FontWeight="SemiBold"
                                          HorizontalAlignment="Center" />
								<TextBlock Text="Expense descriptions mapped to specific tags"
                                          FontSize="12"
                                          HorizontalAlignment="Center"
                                          Opacity="0.7" />
							</StackPanel>
						</Border>

						<!-- Content Area -->
						<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1,0,1,1"
                                CornerRadius="0,0,8,8"
                                MinHeight="400"
                                MaxHeight="600">

							<!-- FIXED: Wrapped multiple children in a Grid -->
							<Grid>
								<!-- Loading State -->
								<StackPanel IsVisible="{Binding IsLoadingED}"
			                               Spacing="15"
			                               VerticalAlignment="Center"
			                               HorizontalAlignment="Center">
									<TextBlock Text="ðŸ”„ Loading expense dictionaries..."
			                                  FontSize="14"
			                                  HorizontalAlignment="Center"
			                                  Opacity="0.7" />
								</StackPanel>

								<!-- Content -->
								<ScrollViewer IsVisible="{Binding !IsLoadingED}"
			                                 VerticalScrollBarVisibility="Auto"
			                                 Padding="15">
									<ItemsControl ItemsSource="{Binding ExpenseTagsInfo}">
										<ItemsControl.ItemTemplate>
											<DataTemplate DataType="{x:Type vm:InfoContainer}">
												<Border Background="{DynamicResource ControlFillColorDefaultBrush}"
			                                           BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
			                                           BorderThickness="1"
			                                           CornerRadius="6"
			                                           Padding="15"
			                                           Margin="0,0,0,8">
													<Grid RowDefinitions="Auto, Auto, Auto">
														<StackPanel Grid.Row="0" Spacing="5">
															<TextBlock Text="Expense Description"
			                                                          FontSize="11"
			                                                          FontWeight="Medium"
			                                                          Opacity="0.7"
			                                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
															<TextBlock Text="{Binding Key}"
			                                                          FontSize="13"
			                                                          TextWrapping="Wrap"
			                                                          FontWeight="Medium"
			                                                          Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
														</StackPanel>

														<StackPanel Grid.Row="1" Spacing="5" Margin="0,10,0,0">
															<TextBlock Text="Assigned Tag"
			                                                          FontSize="11"
			                                                          FontWeight="Medium"
			                                                          Opacity="0.7"
			                                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
															<Border Background="{DynamicResource AccentFillColorDefaultBrush}"
			                                                       CornerRadius="12"
			                                                       Padding="8,4"
			                                                       HorizontalAlignment="Left">
																<TextBlock Text="{Binding Value}"
			                                                              FontSize="11"
			                                                              FontWeight="SemiBold"
			                                                              Foreground="White" />
															</Border>
														</StackPanel>

														<!-- Action Buttons -->
														<StackPanel Grid.Row="2" Margin="0,10,0,0" Orientation="Horizontal" Spacing="8">
															<Button Content="âœï¸ Edit"
																	HorizontalAlignment="Left"
																	Padding="8,4"
																	FontSize="11"
																	CornerRadius="4"
																	Classes="accent"
																	Command="{Binding $parent[UserControl].((vm:DictionariesPageViewModel)DataContext).OpenEditExpenseTagDialogCommand}"
																	CommandParameter="{Binding}"
																	ToolTip.Tip="Edit this expense dictionary entry" />

															<Button Content="ðŸ—‘ï¸ Delete"
																	HorizontalAlignment="Right"
																	Padding="8,4"
																	FontSize="11"
																	CornerRadius="4"
																	Background="#D32F2F"
																	Foreground="White"
																	Command="{Binding DeleteExpenseTagCommand}"
																	ToolTip.Tip="Delete this expense dictionary entry" />
														</StackPanel>
													</Grid>
												</Border>
											</DataTemplate>
										</ItemsControl.ItemTemplate>
									</ItemsControl>
								</ScrollViewer>
							</Grid>
						</Border>
					</StackPanel>

					<!-- Rule Dictionaries Section -->
					<StackPanel Grid.Column="1" Margin="15,0,0,0">
						<!-- Section Header -->
						<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8,8,0,0"
                                Padding="20,15">
							<StackPanel Spacing="5">
								<TextBlock Text="âš™ï¸ Rule Dictionaries"
                                          FontSize="18"
                                          FontWeight="SemiBold"
                                          HorizontalAlignment="Center" />
								<TextBlock Text="Pattern matching rules for automatic tagging"
                                          FontSize="12"
                                          HorizontalAlignment="Center"
                                          Opacity="0.7" />
							</StackPanel>
						</Border>

						<!-- Content Area -->
						<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1,0,1,1"
                                CornerRadius="0,0,8,8"
                                MinHeight="400"
                                MaxHeight="600">

							<!-- FIXED: Wrapped multiple children in a Grid -->
							<Grid>
								<!-- Loading State -->
								<StackPanel IsVisible="{Binding IsLoadingRD}"
			                               Spacing="15"
			                               VerticalAlignment="Center"
			                               HorizontalAlignment="Center">
									<TextBlock Text="ðŸ”„ Loading rule dictionaries..."
			                                  FontSize="14"
			                                  HorizontalAlignment="Center"
			                                  Opacity="0.7" />
								</StackPanel>

								<!-- Content -->
								<ScrollViewer IsVisible="{Binding !IsLoadingRD}"
			                                 VerticalScrollBarVisibility="Auto"
			                                 Padding="15">
									<ItemsControl ItemsSource="{Binding ExpenseRuleTagsInfo}">
										<ItemsControl.ItemTemplate>
											<DataTemplate DataType="{x:Type vm:InfoContainer}">
												<Border Background="{DynamicResource ControlFillColorDefaultBrush}"
			                                           BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
			                                           BorderThickness="1"
			                                           CornerRadius="6"
			                                           Padding="15"
			                                           Margin="0,0,0,8">
													<Grid RowDefinitions="Auto, Auto, Auto">
														<StackPanel Grid.Row="0" Spacing="5">
															<TextBlock Text="Matching Rule"
			                                                          FontSize="11"
			                                                          FontWeight="Medium"
			                                                          Opacity="0.7"
			                                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
															<Border Background="{DynamicResource ControlFillColorInputActiveBrush}"
			                                                       BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
			                                                       BorderThickness="1"
			                                                       CornerRadius="4"
			                                                       Padding="8,6">
																<TextBlock Text="{Binding Key}"
			                                                              FontSize="12"
			                                                              FontFamily="Consolas, 'Courier New', monospace"
			                                                              TextWrapping="Wrap"
			                                                              Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
															</Border>
														</StackPanel>

														<StackPanel Grid.Row="1" Spacing="5" Margin="0,10,0,0">
															<TextBlock Text="Applied Tag"
			                                                          FontSize="11"
			                                                          FontWeight="Medium"
			                                                          Opacity="0.7"
			                                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
															<Border Background="{DynamicResource AccentFillColorDefaultBrush}"
			                                                       CornerRadius="12"
			                                                       Padding="8,4"
			                                                       HorizontalAlignment="Left">
																<TextBlock Text="{Binding Value}"
			                                                              FontSize="11"
			                                                              FontWeight="SemiBold"
			                                                              Foreground="White" />
															</Border>
														</StackPanel>

														<!-- Action Buttons -->
														<StackPanel Grid.Row="2" Margin="0,10,0,0" Orientation="Horizontal" Spacing="8">
															<Button Content="âœï¸ Edit"
																	HorizontalAlignment="Left"
																	Padding="8,4"
																	FontSize="11"
																	CornerRadius="4"
																	Command="{Binding $parent[UserControl].((vm:DictionariesPageViewModel)DataContext).OpenEditExpenseRuleTagDialogCommand}"
																	CommandParameter="{Binding}"
																	ToolTip.Tip="Edit this rule dictionary entry" />

															<Button Content="ðŸ—‘ï¸ Delete"
																	HorizontalAlignment="Right"
																	Padding="8,4"
																	FontSize="11"
																	CornerRadius="4"
																	Background="#D32F2F"
																	Foreground="White"
																	Command="{Binding DeleteExpenseRuleTagCommand}"
																	ToolTip.Tip="Delete this rule dictionary entry" />
														</StackPanel>
													</Grid>
												</Border>
											</DataTemplate>
										</ItemsControl.ItemTemplate>
									</ItemsControl>
								</ScrollViewer>
							</Grid>
						</Border>
					</StackPanel>
				</Grid>

				<!-- Summary Section -->
				<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20"
                        Margin="0,30,0,0">
					<StackPanel Spacing="10">
						<TextBlock Text="ðŸ“Š Dictionary Summary"
                                  FontSize="16"
                                  FontWeight="SemiBold"
                                  HorizontalAlignment="Center" />

						<Grid ColumnDefinitions="1*, 1*">
							<StackPanel Grid.Column="0" Spacing="5" HorizontalAlignment="Center">
								<TextBlock Text="{Binding ExpenseTagsInfo.Count, StringFormat='{}{0} items'}"
                                          FontSize="20"
                                          FontWeight="Bold"
                                          HorizontalAlignment="Center"
                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}" />
								<TextBlock Text="Expense Mappings"
                                          FontSize="12"
                                          HorizontalAlignment="Center"
                                          Opacity="0.7" />
							</StackPanel>

							<StackPanel Grid.Column="1" Spacing="5" HorizontalAlignment="Center">
								<TextBlock Text="{Binding ExpenseRuleTagsInfo.Count, StringFormat='{}{0} rules'}"
                                          FontSize="20"
                                          FontWeight="Bold"
                                          HorizontalAlignment="Center"
                                          Foreground="{DynamicResource AccentTextFillColorSecondaryBrush}" />
								<TextBlock Text="Automation Rules"
                                          FontSize="12"
                                          HorizontalAlignment="Center"
                                          Opacity="0.7" />
							</StackPanel>
						</Grid>
					</StackPanel>
				</Border>
			</StackPanel>
		</ScrollViewer>

		<!-- Edit Dialog Overlay -->
		<Border Background="{DynamicResource SolidBackgroundFillColorBaseBrush}"
				IsVisible="{Binding IsEditDialogOpen}"
				ZIndex="100">
			<Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
					BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
					BorderThickness="2"
					CornerRadius="12"
					Padding="30"
					MaxWidth="500"
					MaxHeight="400"
					HorizontalAlignment="Center"
					VerticalAlignment="Center">

				<StackPanel Spacing="20">
					<!-- Dynamic Dialog Header -->
					<StackPanel Spacing="8">
						<TextBlock Text="{Binding DialogTitle}"
								   FontSize="20"
								   FontWeight="SemiBold"
								   HorizontalAlignment="Center"
								   Foreground="{DynamicResource TextControlForeground}" />
						<TextBlock Text="{Binding DialogSubtitle}"
								   FontSize="12"
								   HorizontalAlignment="Center"
								   Opacity="0.7"
								   Foreground="{DynamicResource TextControlForeground}" />
					</StackPanel>

					<!-- Form Content -->
					<StackPanel Spacing="15">
						<!-- Item Name (Read-only) - Dynamic label -->
						<StackPanel Spacing="5">
							<TextBlock Text="{Binding ItemFieldLabel}"
									   FontSize="12"
									   FontWeight="Medium"
									   Opacity="0.7"
									   Foreground="{DynamicResource TextControlForeground}" />
							<Border Background="{DynamicResource ControlFillColorDisabledBrush}"
									BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
									BorderThickness="1"
									CornerRadius="6"
									Padding="12,8">
								<TextBlock Text="{Binding EditItemName}"
										   FontSize="13"
										   TextWrapping="Wrap"
										   Foreground="{DynamicResource TextControlForeground}"
										   Opacity="0.8"
										   FontFamily="{Binding CurrentEditType, Converter={x:Static vm:EditTypeToFontFamilyConverter.Instance}}" />
							</Border>
						</StackPanel>

						<!-- Tag Dropdown -->
						<StackPanel Spacing="5">
							<TextBlock Text="Select Tag"
									   FontSize="12"
									   FontWeight="Medium"
									   Opacity="0.7"
									   Foreground="{DynamicResource TextControlForeground}" />
							<ComboBox ItemsSource="{Binding AvailableTags}"
									  SelectedItem="{Binding SelectedTag}"
									  MinHeight="40"
									  FontSize="13"
									  Background="{DynamicResource ControlFillColorDefaultBrush}"
									  BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
									  CornerRadius="6"
									  PlaceholderText="Choose a tag..." />
						</StackPanel>

						<!-- IsIgnored Checkbox -->
						<CheckBox IsChecked="{Binding IsIgnored}"
								  Content="Ignore this entry"
								  FontSize="13"
								  Margin="0,5,0,0"
								  ToolTip.Tip="Mark this entry as ignored to exclude it from processing" />
					</StackPanel>

					<!-- Dialog Buttons -->
					<StackPanel Orientation="Horizontal"
								Spacing="12"
								HorizontalAlignment="Center"
								Margin="0,10,0,0">
						<Button Content="Cancel"
								Padding="20,8"
								FontSize="13"
								Background="{DynamicResource ControlFillColorDefaultBrush}"
								Foreground="{DynamicResource TextFillColorPrimaryBrush}"
								BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
								BorderThickness="1"
								CornerRadius="6"
								Command="{Binding CloseEditDialogCommand}" />

						<Button Content="Save Changes"
								Padding="20,8"
								FontSize="13"
								Classes="accent"
								CornerRadius="6"
								Command="{Binding HandleEditSubmitCommand}" />
					</StackPanel>
				</StackPanel>
			</Border>
		</Border>
	</Grid>
</UserControl>