<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="IBudget.GUI.Views.ManualEntryPageView"
             xmlns:vm="using:IBudget.GUI.ViewModels"
             x:DataType="vm:ManualEntryPageViewModel"
             x:CompileBindings="True">

    <UserControl.Styles>
        <Style Selector="Button.selected">
            <Setter Property="Background" Value="{DynamicResource AccentFillColorDefaultBrush}"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
    </UserControl.Styles>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="32,24" RowDefinitions="Auto,Auto,*" MaxWidth="1000">
            
            <!-- Page Header -->
            <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,24">
                <TextBlock Text="MANUAL ENTRY" 
                          FontSize="11" 
                          FontWeight="Bold" 
                          LetterSpacing="2"
                          Opacity="0.6"
                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}" />
                <TextBlock Text="Add Income or Expense" 
                          FontSize="32" 
                          FontWeight="Black" 
                          LineHeight="38"
                          Foreground="{DynamicResource TextControlForeground}" />
                <TextBlock Text="Manually record your financial transactions" 
                          FontSize="14" 
                          Opacity="0.65" />
            </StackPanel>

            <!-- Type Selector -->
            <Border Grid.Row="1" 
                    Background="{DynamicResource LayerFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="8"
                    Margin="0,0,0,24">
                <Grid ColumnDefinitions="*,*">
                    <!-- Expense Button -->
                    <Button Grid.Column="0"
                            Padding="16,12"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            CornerRadius="8"
                            Command="{Binding SwitchToExpenseCommand}"
                            Classes.selected="{Binding IsExpenseSelected}">
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                            <PathIcon Data="{StaticResource ArrowDownRegular}" 
                                     Width="20" Height="20" />
                            <TextBlock Text="Expense" 
                                      FontSize="15" 
                                      FontWeight="SemiBold"
                                      VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <!-- Income Button -->
                    <Button Grid.Column="1"
                            Padding="16,12"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            CornerRadius="8"
                            Command="{Binding SwitchToIncomeCommand}"
                            Classes.selected="{Binding !IsExpenseSelected}">
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                            <PathIcon Data="{StaticResource ArrowUpRegular}" 
                                     Width="20" Height="20" />
                            <TextBlock Text="Income" 
                                      FontSize="15" 
                                      FontWeight="SemiBold"
                                      VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <!-- Main Form -->
            <Border Grid.Row="2"
                    Background="{DynamicResource LayerFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="16"
                    Padding="32,28"
                    BoxShadow="0 2 8 0 #10000000">
                <StackPanel Spacing="24">
                    
                    <!-- Form Fields -->
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto">
                        
                        <!-- Date Field -->
                        <StackPanel Grid.Column="0" Grid.Row="0" Spacing="8" Margin="0,0,8,10">
                            <TextBlock Text="Date" FontWeight="SemiBold" FontSize="14" />
                            <DatePicker SelectedDate="{Binding SelectedDate}"
                                       HorizontalAlignment="Stretch" />
                        </StackPanel>

                        <!-- Amount Field -->
                        <StackPanel Grid.Column="1" Grid.Row="0" Spacing="8" Margin="8,0,0,10">
                            <TextBlock Text="Amount" FontWeight="SemiBold" FontSize="14" />
                            <NumericUpDown Value="{Binding Amount}"
                                          Minimum="0"
                                          Increment="0.01"
                                          FormatString="C2"
                                          HorizontalAlignment="Stretch"
                                          Watermark="0.00" />
                        </StackPanel>

                        <!-- Notes Field (Expense only) -->
                        <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2" Spacing="8" Margin="0,0,0,10"
                                   IsVisible="{Binding IsExpenseSelected}">
                            <TextBlock Text="Notes" FontWeight="SemiBold" FontSize="14" />
                            <TextBox Text="{Binding Notes}"
                                    Watermark="Enter notes..."
                                    AcceptsReturn="True"
                                    TextWrapping="Wrap"
                                    Height="80"
                                    HorizontalAlignment="Stretch" />
                        </StackPanel>

                        <!-- Source Field (Income only) -->
                        <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2" Spacing="8" Margin="0,0,0,10"
                                   IsVisible="{Binding !IsExpenseSelected}">
                            <TextBlock Text="Source" FontWeight="SemiBold" FontSize="14" />
                            <TextBox Text="{Binding Source}"
                                    Watermark="Income source..."
                                    HorizontalAlignment="Stretch" />
                        </StackPanel>

                        <!-- Tag Input Section -->
                        <StackPanel Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="2" Spacing="12" Margin="0,0,0,10">
                            <TextBlock Text="Tags" FontWeight="SemiBold" FontSize="14" />
                            
                            <!-- Tag Input with AutoComplete -->
                            <StackPanel Spacing="8">
                                <AutoCompleteBox ItemsSource="{Binding ExistingTags}"
                                               FilterMode="Contains"
                                               Watermark="Enter or select a tag"
                                               Text="{Binding CurrentTag}"
                                               CornerRadius="8"
                                               Padding="12">
                                    <AutoCompleteBox.KeyBindings>
                                        <KeyBinding Gesture="Enter" Command="{Binding AddTagCommand}" />
                                    </AutoCompleteBox.KeyBindings>
                                </AutoCompleteBox>
                                <Button Content="Add Tag"
                                       Command="{Binding AddTagCommand}"
                                       HorizontalAlignment="Right"
                                       Padding="16,8"
                                       CornerRadius="6" />
                            </StackPanel>

                            <!-- Selected Tags Display -->
                            <Border Background="{DynamicResource LayerOnMicaBaseAltFillColorDefaultBrush}"
                                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                   BorderThickness="1"
                                   CornerRadius="8"
                                   MinHeight="80"
                                   Padding="12"
                                   IsVisible="{Binding SelectedTags.Count}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120">
                                    <ItemsControl ItemsSource="{Binding SelectedTags}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{DynamicResource AccentFillColorTertiaryBrush}"
                                                       CornerRadius="12"
                                                       Padding="10,6"
                                                       Margin="4">
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <TextBlock Text="{Binding Name}" 
                                                                  VerticalAlignment="Center"
                                                                  FontSize="13" />
                                                        <Button Padding="4"
                                                               Background="Transparent"
                                                               BorderThickness="0"
                                                               Command="{Binding $parent[UserControl].((vm:ManualEntryPageViewModel)DataContext).RemoveTagCommand}"
                                                               CommandParameter="{Binding}"
                                                               ToolTip.Tip="Remove tag">
                                                            <PathIcon Data="{StaticResource DismissRegular}" 
                                                                     Width="12" Height="12" />
                                                        </Button>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </StackPanel>

                    </Grid>

                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,Auto,Auto">
                        <!-- Status Message -->
                        <Border Grid.Column="0"
                               Background="{DynamicResource AccentFillColorTertiaryBrush}"
                               CornerRadius="8"
                               Padding="16,12"
                               Margin="0,0,12,0"
                               IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               HorizontalAlignment="Stretch">
                            <TextBlock Text="{Binding StatusMessage}"
                                      FontWeight="SemiBold"
                                      Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"
                                      VerticalAlignment="Center" />
                        </Border>

                        <!-- Clear Button -->
                        <Button Grid.Column="1"
                               Content="Clear"
                               Padding="20,12"
                               FontSize="14"
                               CornerRadius="8"
                               Margin="0,0,12,0"
                               HorizontalAlignment="Center"
                               Command="{Binding ClearFormCommand}" />

                        <!-- Submit Button -->
                        <Button Grid.Column="2"
                               Padding="24,12"
                               FontSize="14"
                               FontWeight="SemiBold"
                               CornerRadius="8"
                               Classes="accent"
                               HorizontalAlignment="Center"
                               Command="{Binding SubmitEntryCommand}"
                               IsEnabled="{Binding !IsLoading}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="{StaticResource CheckmarkRegular}" 
                                         Width="18" Height="18"
                                         IsVisible="{Binding !IsLoading}" />
                                <TextBlock Text="{Binding SubmitButtonText}" />
                            </StackPanel>
                        </Button>
                    </Grid>

                </StackPanel>
            </Border>

        </Grid>
    </ScrollViewer>

</UserControl>
